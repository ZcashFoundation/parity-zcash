name: On Push

on: push

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Setup Google Cloud
      uses: actions/gcloud/auth@master
      env:
        GCLOUD_AUTH: ${{ secrets.GCLOUD_AUTH }}
    - name: Build, Test, Tag, and Push to GCR
      uses: actions/gcloud/cli@master
      with:
        entrypoint: sh
        args: -l -c "SHORT_SHA=$(echo ${{ github.sha }} | head -c7) && BRANCH_NAME=$(git
          name-rev --name-only HEAD) && gcloud builds submit . --config cloudbuild.yaml
          --project zebrad --substitutions BRANCH_NAME=$BRANCH_NAME"
    - name: Build Fuzzers
      uses: docker://gcr.io/zebrad/master:latest
      if: github.ref == 'ref/heads/master'
      with:
        entrypoint: sh
        args: -c "cd fuzz/; cargo install --force afl honggfuzz; cargo hfuzz build; cargo afl build; exit 0"
